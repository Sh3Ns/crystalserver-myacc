<script type="text/javascript">
	var eventId = 0;
	var lastSend = 0;

	$(function() {
		updateFlag();
		initializeIndicators();

		$('#account_country').change(function() {
			updateFlag();
		});

		$('#account_input').blur(function() {
			checkAccount();
		});
		$('#email').blur(function() {
			checkEmail();
		});
		$('#password').blur(function() {
			checkPassword();
		});
		$('#password2').blur(function() {
			checkPassword();
		});
		$('#character_name').blur(function() {
      checkName();
    });
		$('#character_name').keyup(function() {
      checkName();
    });
		$('#SuggestAccountNumber a').click(function (event) {
			generateAccountNumber(event);
		});
		$('#SuggestCharacterName a').click(function (event) {
      generateCharacterName(event);
    });
	});

	 function initializeIndicators()
  {
    // Display all indicators as 'nok' (X) on page load
    $('#account_indicator').attr('src', 'images/global/general/nok.gif').show();
    $('#email_indicator').attr('src', 'images/global/general/nok.gif').show();
    $('#password_indicator').attr('src', 'images/global/general/nok.gif').show();
    $('#password2_indicator').attr('src', 'images/global/general/nok.gif').show();
    $('#character_indicator').attr('src', 'images/global/general/nok.gif').show();
  }

	function updateFlag()
	{
		// Update country flag based on selected country
		var img = $('#account_country_img');
		var country = $('#account_country :selected').val();
		if(country.length) {
			img.attr('src', 'images/flags/' + country + '.gif');
			img.show();
		}
		else {
			img.hide();
		}
	}

	function checkAccount()
	{
		// Clear any pending interval timers
		if(eventId != 0)
		{
			clearInterval(eventId)
			eventId = 0;
		}

		// Validate that account field is not empty
		if(document.getElementById("account_input").value == "")
		{
			$('#account_error').html('Please enter account number.');
			$('#account_indicator').attr('src', 'images/global/general/nok.gif');
			$('#account_indicator').show();
			return;
		}

		// Anti-flood prevention: wait at least 1.1 seconds between requests
		var date = new Date;
		var timeNow = parseInt(date.getTime());

		if(lastSend != 0)
		{
			if(timeNow - lastSend < 1100)
			{
				eventId = setInterval('checkAccount()', 1100)
				return;
			}
		}

		// Send AJAX request to validate account
		var account = document.getElementById("account_input").value;
		$.getJSON("tools/validate.php", { account: account, uid: Math.random() },
			function(data){
				if(data.hasOwnProperty('success')) {
					$('#account_error').html ('');
					$('#account_indicator').attr('src', 'images/global/general/ok.gif');
				}
				else if(data.hasOwnProperty('error')) {
					$('#account_error').html(data.error);
					$('#account_indicator').attr('src', 'images/global/general/nok.gif');
				}

				$('#account_indicator').show();
			}
		);

		lastSend = timeNow;
	}

	function checkEmail()
	{
		// Clear any pending interval timers
		if(eventId != 0)
		{
			clearInterval(eventId)
			eventId = 0;
		}

		// Validate that email field is not empty
		if(document.getElementById("email").value == "")
		{
			$('#email_error').html('Please enter e-mail.');
			$('#email_indicator').attr('src', 'images/global/general/nok.gif');
			$('#email_indicator').show();
			return;
		}

		// Anti-flood prevention: wait at least 1.1 seconds between requests
		var date = new Date;
		var timeNow = parseInt(date.getTime());

		if(lastSend != 0)
		{
			if(timeNow - lastSend < 1100)
			{
				eventId = setInterval('checkEmail()', 1100)
				return;
			}
		}

		// Send AJAX request to validate email
		var email = document.getElementById("email").value;
		$.getJSON("tools/validate.php", { email: email, uid: Math.random() },
			function(data){
				if(data.hasOwnProperty('success')) {
					$('#email_error').html ('');
					$('#email_indicator').attr('src', 'images/global/general/ok.gif');
				}
				else if(data.hasOwnProperty('error')) {
					$('#email_error').html(data.error);
					$('#email_indicator').attr('src', 'images/global/general/nok.gif');
				}

				$('#email_indicator').show();
			}
		);

		lastSend = timeNow;
	}

	function checkPassword()
	{
		// Clear any pending interval timers
		if(eventId != 0)
		{
			clearInterval(eventId)
			eventId = 0;
		}

		// Validate that password field is not empty
		if(document.getElementById("password").value == "")
		{
			$('#password_error').html('Please enter the password for your new account.');
			$('#password_indicator').attr('src', 'images/global/general/nok.gif');
			$('#password_indicator').show();
			return;
		}

		// Validate that password confirmation field is not empty
		if(document.getElementById("password2").value == "")
		{
			$('#password2_error').html('Please enter the password again!');
			$('#password2_indicator').attr('src', 'images/global/general/nok.gif');
			$('#password2_indicator').show();
			return;
		}

		// Anti-flood prevention: wait at least 1.1 seconds between requests
		var date = new Date;
		var timeNow = parseInt(date.getTime());

		if(lastSend != 0)
		{
			if(timeNow - lastSend < 1100)
			{
				eventId = setInterval('checkPassword()', 1100)
				return;
			}
		}

		var password = document.getElementById("password").value;
		var password2 = document.getElementById("password2").value;
		$.getJSON("tools/validate.php", { password: password, password2: password2, uid: Math.random() },
			function(data){
				if(data.hasOwnProperty('success')) {
					$('#password_error').html ('');
					$('#password2_error').html ('');
					$('#password_indicator').attr('src', 'images/global/general/ok.gif');
					$('#password2_indicator').attr('src', 'images/global/general/ok.gif');
				}
				else if(data.hasOwnProperty('error')) {
					$('#password_error').html(data.error);
					$('#password2_error').html(data.error);
					$('#password_indicator').attr('src', 'images/global/general/nok.gif');
					$('#password2_indicator').attr('src', 'images/global/general/nok.gif');
				}

				$('#password_indicator').show();
				$('#password2_indicator').show();
			}
		);

		lastSend = timeNow;
	}

	function generateAccountNumber(event)
	{
		// Prevent default link behavior
		event.preventDefault();

		// Fetch a suggested account number from the server
		$.getJSON("tools/generate_account_number.php", { uid: Math.random() },
			function(data){
				if(data.hasOwnProperty('success')) {
					$('#account_input').val(data.success);
				}
			}
		);

		// Validate the generated account number after 1 second
		setTimeout(checkAccount, 1000);
	}

  function generateCharacterName(event)
  {
    // Prevent default link behavior
    event.preventDefault();

    // Arrays for random name generation
    var prefixes = ['Ad', 'Al', 'Ar', 'Az', 'Be', 'Br', 'Ca', 'Ce', 'Ch', 'Cl', 'Co', 'Cr', 'Cu', 'Da', 'De', 'Di', 'Do', 'Dr', 'Du', 'El', 'Em', 'En', 'Er', 'Es', 'Et', 'Ex', 'Fa', 'Fe', 'Fi', 'Fl', 'Fo', 'Fr', 'Fu', 'Ga', 'Ge', 'Gi', 'Gl', 'Go', 'Gr', 'Gu', 'Ha', 'He', 'Hi', 'Ho', 'Hu', 'Hy', 'Ia', 'Id', 'If', 'Ig', 'Il', 'Im', 'In', 'Io', 'Ir', 'Is', 'It', 'Ja', 'Je', 'Ji', 'Jo', 'Ju', 'Ka', 'Ke', 'Ki', 'Ko', 'Ku', 'La', 'Le', 'Li', 'Lo', 'Lu', 'Ma', 'Me', 'Mi', 'Mo', 'Mu', 'Na', 'Ne', 'Ni', 'No', 'Nu'];
    var middles = ['a', 'ae', 'ai', 'an', 'ar', 'as', 'at', 'au', 'e', 'ea', 'ed', 'ee', 'ef', 'eg', 'eh', 'ei', 'ek', 'el', 'em', 'en', 'er', 'es', 'et', 'eu', 'ev', 'ew', 'ex', 'ey', 'ez', 'i', 'ia', 'id', 'if', 'ig', 'ih', 'ik', 'il', 'im', 'in', 'ir', 'is', 'it', 'iu', 'ix', 'iy', 'o', 'oa', 'ob', 'od', 'of', 'og', 'oh', 'oi', 'ok', 'ol', 'om', 'on', 'op', 'or', 'os', 'ot', 'ou', 'ov', 'ox', 'oy', 'oz', 'u', 'ua', 'ub', 'ud', 'ue', 'ug', 'uh', 'ui', 'uk', 'ul', 'um', 'un', 'up', 'ur', 'us', 'ut', 'uu', 'uy', 'uz'];
    var suffixes = ['ad', 'af', 'ag', 'ah', 'ak', 'al', 'am', 'an', 'ap', 'ar', 'as', 'at', 'ax', 'ay', 'az', 'ed', 'ef', 'eg', 'eh', 'ek', 'el', 'em', 'en', 'ep', 'er', 'es', 'et', 'ex', 'ey', 'ez', 'id', 'if', 'ig', 'ih', 'ik', 'il', 'im', 'in', 'ip', 'ir', 'is', 'it', 'ix', 'iz', 'od', 'of', 'og', 'oh', 'ok', 'ol', 'om', 'on', 'op', 'or', 'os', 'ot', 'ox', 'oy', 'oz', 'ud', 'uf', 'ug', 'uh', 'uk', 'ul', 'um', 'un', 'up', 'ur', 'us', 'ut', 'ux', 'uy', 'uz'];

    // Select random elements from each array
    var p = prefixes[Math.floor(Math.random() * prefixes.length)];
    var m = middles[Math.floor(Math.random() * middles.length)];
    var s = suffixes[Math.floor(Math.random() * suffixes.length)];

    // Set the generated name to the character name field
    $('#character_name').val(p + m + s);

    // Validate the generated character name after 100 milliseconds
    setTimeout(checkName, 100);
  }
</script>
